<!DOCTYPE html>
<html lang="en">
<!-- Head and styles remain the same - no changes needed -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicTest - Test Your Microphone Online</title>
  <link rel="canonical" href="https://mic-tests.github.io/">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        canvas {
            width: 100%;
            height: 150px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        .info-label {
            font-weight: bold;
        }
        .footer {
            margin-top: 50px;
            padding: 20px 0;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        .testimonial {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .testimonial:last-child {
            border-bottom: none;
        }
        .status-message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .recording-pulse {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            margin-right: 8px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 8px rgba(220, 53, 69, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
            }
        }
        .quality-indicator {
            display: inline-block;
            font-weight: bold;
        }
        .quality-excellent {
            color: #198754;
        }
        .quality-verygood {
            color: #0d6efd;
        }
        .quality-good {
            color: #6f42c1;
        }
        .quality-fair {
            color: #fd7e14;
        }
        .quality-poor {
            color: #dc3545;
        }
        .quality-unknown {
            color: #6c757d;
        }
        #visualizer-container {
            position: relative;
        }
        .amplitude-bars {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: flex-end;
            padding: 0 5px;
        }
        .amplitude-bar {
            flex: 1;
            background-color: rgba(13, 110, 253, 0.5);
            margin: 0 1px;
            max-height: 100%;
            transition: height 0.1s ease;
        }
        .review-form {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .status-step {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .status-icon {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .mic-instructions {
            margin-bottom: 15px;
        }
    </style>
  <meta name="google-adsense-account" content="ca-pub-5426315045205785">
</head>
<body>
    <!-- Nav and UI HTML remain the same - no changes needed -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-mic-fill me-2"></i>MicTest
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
<ul class="navbar-nav">
    <li class="nav-item">
        <a class="nav-link active" aria-current="page" href="/">Home</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="/show-mic">Show My Mic</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="/show-speakers">Show My Speakers</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="/about">About</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="/contact">Contact</a>
    </li>
</ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="alert alert-info" id="browser-alert">
            <div id="browser-message">
                <i class="bi bi-info-circle-fill me-2"></i>
                A microphone was detected. Press "Test my mic" to check the functionality and supported properties of your microphone.
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
<h1><i class="bi bi-mic-fill me-2"></i>Test Your Microphone Online for Free</h1>
                <p class="lead">A simple online mic test that allows you to check if your microphone is working properly.</p>

                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Microphone Visualizer</h5>

                        <div id="status-message" class="status-message alert alert-info mb-3">
                            <div class="status-step">
                                <span class="status-icon"><i class="bi bi-arrow-right-circle-fill"></i></span>
                                <span>Select your microphone from the dropdown and press "Test my mic" to begin.</span>
                            </div>
                        </div>

                        <div id="visualizer-container">
                            <canvas id="visualizer"></canvas>
                            <div class="amplitude-bars" id="amplitude-bars"></div>
                        </div>

                        <div class="d-flex justify-content-between mt-3">
                            <select id="mic-select" class="form-select w-50 me-2" disabled>
                                <option value="">Loading microphones...</option>
                            </select>
                            <button id="test-button" class="btn btn-primary">
                                <i class="bi bi-mic-fill me-2"></i>Test my mic
                            </button>
                        </div>

                        <div id="recording-controls" class="mt-3 d-none">
                            <div class="progress mb-2">
                                <div id="recording-progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="mic-instructions alert alert-primary" id="recording-instructions">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                Please say "Hello" or make some noise. The tester records the sound captured by your mic and you will be able to playback it after testing is complete.
                            </div>
                            <div class="btn-toolbar">
                                <button id="play-button" class="btn btn-secondary me-2" disabled>
                                    <i class="bi bi-play-fill me-1"></i>Play Recording
                                </button>
                                <button id="pause-button" class="btn btn-warning me-2 d-none">
                                    <i class="bi bi-pause-fill me-1"></i>Pause
                                </button>
                                <button id="stop-recording-button" class="btn btn-danger me-2">
                                    <i class="bi bi-stop-fill me-1"></i>Stop Recording
                                </button>
                                <button id="restart-button" class="btn btn-outline-secondary me-2 d-none">
                                    <i class="bi bi-arrow-repeat me-1"></i>Restart
                                </button>
                                <button id="share-button" class="btn btn-outline-primary me-2 d-none">
                                    <i class="bi bi-share-fill me-1"></i>Share Results
                                </button>
                            </div>
                            <!-- Add audio player element -->
                            <div id="audio-player-container" class="mt-3 d-none">
                                <audio id="audio-player" controls></audio>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rest of the HTML content remains the same -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Why do you need a mic test?</h5>
                        <ul>
                            <li>Have purchased or connected a new microphone and want to check if it works properly.</li>
                            <li>Want to check if headset microphone is enabled.</li>
                            <li>Verify if computer microphone doesn't distort your voice.</li>
                            <li>Find if webcam has a built-in microphone.</li>
                            <li>Make sure that other applications can detect your microphones.</li>
                            <li>Want to admire the microphone visualizer.</li>
                            <li>Just out of curiosity.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-info-circle-fill me-2"></i>Microphone Information
                    </div>
                    <div class="card-body">
                        <div class="info-row">
                            <span class="info-label">Quality Rating:</span>
                            <span id="quality-rating" class="quality-indicator quality-unknown">—</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Microphone Name:</span>
                            <span id="mic-name">Not selected</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Automatic Gain Control:</span>
                            <span id="gain-control">—</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Number of Audio Channels:</span>
                            <span id="channels">—</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Echo Cancellation:</span>
                            <span id="echo-cancellation">—</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Estimated Latency:</span>
                            <span id="latency">—</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Noise Suppression:</span>
                            <span id="noise-suppression">—</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Sample Rate:</span>
                            <span id="sample-rate">—</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Sample Size:</span>
                            <span id="sample-size">—</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Volume:</span>
                            <span id="volume">—</span>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-chat-quote-fill me-2"></i>User Testimonials
                    </div>
                    <div class="card-body">
                        <div class="testimonial">
                            <p class="mb-0">"Very good website I love it"</p>
                            <small class="text-muted">— Bob Smith</small>
                        </div>
                        <div class="testimonial">
                            <p class="mb-0">"I like this site"</p>
                            <small class="text-muted">— John Doe</small>
                        </div>
                        <div class="testimonial">
                            <p class="mb-0">"Good testing tool"</p>
                            <small class="text-muted">— Jane Brown</small>
                        </div>
                        <div class="testimonial">
                            <p class="mb-0">"Thank you"</p>
                            <small class="text-muted">— King S</small>
                        </div>
                        <div class="mt-3">
                            <button id="add-review-btn" class="btn btn-sm btn-outline-primary w-100">
                                <i class="bi bi-plus-circle me-1"></i>Add Your Review
                            </button>
                        </div>
                        <div class="review-form" id="review-form">
                            <div class="mb-3">
                                <label for="review-text" class="form-label">Your Review</label>
                                <textarea class="form-control" id="review-text" rows="3" placeholder="Share your experience..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="reviewer-name" class="form-label">Your Name</label>
                                <input type="text" class="form-control" id="reviewer-name" placeholder="John Doe">
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" type="button" id="submit-review-btn">Submit Review</button>
                                <button class="btn btn-outline-secondary" type="button" id="cancel-review-btn">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <div class="row mt-5">
            <div class="col-md-12">
                <h2><i class="bi bi-speaker-fill me-2"></i>Understanding Microphone Technology</h2>

                <div class="card mb-4">
                    <div class="card-body">
                        <h3>What Makes a Good Microphone?</h3>
                        <p>The quality of a microphone depends on several technical specifications that affect its performance. Understanding these specifications can help you evaluate your microphone's capabilities:</p>

                        <ul class="list-group list-group-flush mb-4">
                            <li class="list-group-item">
                                <h5>Frequency Response (Hz)</h5>
                                <p>Frequency response indicates the range of sound frequencies a microphone can capture effectively. The human hearing range spans from approximately 20Hz to 20,000Hz (20kHz). A wider frequency range generally means the microphone can capture more of the audio spectrum, from deep bass to high treble.</p>
                                <p>For speech recording, a microphone that performs well in the 85Hz to 15kHz range is usually sufficient. However, for music recording, a wider range is often desirable to capture the full spectrum of instruments.</p>
                            </li>
                            <li class="list-group-item">
                                <h5>Sensitivity</h5>
                                <p>Sensitivity measures how effectively a microphone converts acoustic pressure into electrical output. Higher sensitivity means a microphone can pick up quieter sounds, but it may also capture more background noise. Lower sensitivity microphones may require you to speak closer or more loudly, but they can be better at isolating your voice in noisy environments.</p>
                            </li>
                            <li class="list-group-item">
                                <h5>Signal-to-Noise Ratio (SNR)</h5>
                                <p>SNR indicates the level of desired signal compared to the level of background noise. A higher SNR (measured in decibels) means cleaner audio with less background noise. Professional-grade microphones typically have an SNR of 70dB or higher, while consumer-grade microphones may have an SNR of 50-60dB.</p>
                            </li>
                            <li class="list-group-item">
                                <h5>Sample Rate</h5>
                                <p>Sample rate refers to how many times per second the microphone captures the audio signal (measured in Hz). The industry standard for high-quality audio is 44.1kHz or 48kHz, meaning the audio is sampled 44,100 or 48,000 times per second. Higher sample rates can capture more detail but require more processing power and storage.</p>
                            </li>
                            <li class="list-group-item">
                                <h5>Bit Depth (Sample Size)</h5>
                                <p>Bit depth determines the number of possible amplitude values that can be assigned to each audio sample. Higher bit depths allow for more dynamic range and detail in the audio recording. Common bit depths include 16-bit (CD quality), 24-bit (professional audio), and 32-bit (high-end recording). Each additional bit doubles the potential dynamic range.</p>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <h3>Types of Microphones</h3>
                        <p>Different microphone designs serve various purposes and perform differently in different environments:</p>

                        <div class="row">
                            <div class="col-md-6">
                                <h5><i class="bi bi-mic me-2"></i>Dynamic Microphones</h5>
                                <p>Dynamic microphones use a simple magnetic diaphragm system that's durable and can handle high sound pressure levels. They're ideal for live performances, loud environments, and recording loud instruments. They typically don't require external power and are less sensitive to environmental factors like humidity.</p>
                                <p><strong>Best for:</strong> Live settings, recording drums/amplifiers, outdoor recording, and environments where durability is essential.</p>
                            </div>
                            <div class="col-md-6">
                                <h5><i class="bi bi-mic-fill me-2"></i>Condenser Microphones</h5>
                                <p>Condenser microphones use an electrically-charged diaphragm and require phantom power to operate. They offer higher sensitivity and a wider frequency response compared to dynamic microphones, making them excellent for capturing subtle details in sound. However, they're more fragile and sensitive to humidity.</p>
                                <p><strong>Best for:</strong> Studio recording, vocals, acoustic instruments, podcasting, and any application requiring detailed sound capture.</p>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h5><i class="bi bi-mic me-2"></i>Ribbon Microphones</h5>
                                <p>Ribbon microphones use a thin metal ribbon suspended in a magnetic field. They're known for their warm, natural sound and figure-8 pickup pattern. Traditional ribbon microphones are delicate and expensive, though modern designs have improved durability.</p>
                                <p><strong>Best for:</strong> Studio recording, especially for capturing vintage sounds, brass instruments, and situations where a natural, warm tone is desired.</p>
                            </div>
                            <div class="col-md-6">
                                <h5><i class="bi bi-mic-fill me-2"></i>USB Microphones</h5>
                                <p>USB microphones have built-in analog-to-digital converters and connect directly to computers via USB. They're convenient for home recording, streaming, and video conferencing. Quality varies widely, but high-end USB microphones can deliver professional-grade results.</p>
                                <p><strong>Best for:</strong> Podcasting, streaming, video calls, simple home recording setups, and users who need plug-and-play functionality.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <h3>Microphone Pickup Patterns</h3>
                        <p>The pickup pattern (or polar pattern) of a microphone determines from which directions it captures sound:</p>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="text-center mb-3">
                                    <i class="bi bi-record-circle" style="font-size: 3rem;"></i>
                                </div>
                                <h5 class="text-center">Omnidirectional</h5>
                                <p>Picks up sound equally from all directions. Ideal for capturing ambient sound or multiple speakers around the microphone.</p>
                                <p><strong>Best for:</strong> Group discussions, field recording, capturing room ambience.</p>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center mb-3">
                                    <i class="bi bi-caret-up-fill" style="font-size: 3rem;"></i>
                                </div>
                                <h5 class="text-center">Cardioid</h5>
                                <p>Heart-shaped pattern that primarily captures sound from the front while rejecting sound from the rear. Most common for single-person use.</p>
                                <p><strong>Best for:</strong> Vocals, podcasting, streaming, and reducing background noise.</p>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center mb-3">
                                    <i class="bi bi-8-circle" style="transform: rotate(90deg); font-size: 3rem;"></i>
                                </div>
                                <h5 class="text-center">Figure-8 (Bidirectional)</h5>
                                <p>Captures sound from front and back while rejecting sound from the sides. Useful for recording duets or interviews.</p>
                                <p><strong>Best for:</strong> Face-to-face interviews, duets, and recording instruments like guitar cabinets.</p>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="text-center mb-3">
                                    <i class="bi bi-caret-up-fill" style="font-size: 3rem; transform: scale(1.5, 1);"></i>
                                </div>
                                <h5 class="text-center">Supercardioid/Hypercardioid</h5>
                                <p>Narrower pickup patterns than cardioid, offering better side rejection but with some sensitivity at the rear. Excellent for isolating a sound source in noisy environments.</p>
                                <p><strong>Best for:</strong> Film dialogue, stage performances, and isolating a speaker in a noisy environment.</p>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center mb-3">
                                    <i class="bi bi-play-fill" style="font-size: 3rem;"></i>
                                </div>
                                <h5 class="text-center">Shotgun</h5>
                                <p>Highly directional pattern that focuses on sounds directly in front of the microphone while strongly rejecting sounds from other directions.</p>
                                <p><strong>Best for:</strong> Film production, field recording, capturing distant sounds, and situations requiring extreme isolation of the sound source.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-md-12">
                <h2><i class="bi bi-tools me-2"></i>Advanced Microphone Features</h2>

                <div class="card mb-4">
                    <div class="card-body">
                        <h3>Digital Signal Processing (DSP) Features</h3>
                        <p>Modern microphones, especially those built into computers and mobile devices, often include digital signal processing features to improve audio quality:</p>

                        <div class="row">
                            <div class="col-md-6">
                                <h5><i class="bi bi-sliders me-2"></i>Automatic Gain Control</h5>
                                <p>Automatically adjusts the microphone's sensitivity based on the input volume. This helps prevent audio clipping when someone speaks loudly and boosts the signal when someone speaks softly. While convenient, it may create unnatural volume fluctuations in professional recordings.</p>
                            </div>
                            <div class="col-md-6">
                                <h5><i class="bi bi-x-circle me-2"></i>Echo Cancellation</h5>
                                <p>Removes echo that occurs when your microphone picks up sound from your speakers. This is especially important for video conferencing to prevent feedback loops. Echo cancellation algorithms analyze the outgoing audio and remove it from the incoming microphone signal.</p>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h5><i class="bi bi-volume-down me-2"></i>Noise Suppression</h5>
                                <p>Reduces background noise by filtering out frequencies that don't match the typical pattern of human speech. While this can significantly improve clarity in noisy environments, aggressive noise suppression may affect the natural quality of your voice.</p>
                            </div>
                            <div class="col-md-6">
                                <h5><i class="bi bi-mic-mute me-2"></i>Background Noise Removal</h5>
                                <p>More advanced than simple noise suppression, this feature uses AI algorithms to identify and remove specific background noises like keyboard typing, fan noise, or traffic. The best implementations can dramatically improve audio clarity without affecting voice quality.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <h3>Audio Latency</h3>
                        <p>Latency refers to the delay between when sound enters your microphone and when it's processed and available for playback or recording. Low latency is critical for real-time applications:</p>

                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <h5>What Causes Latency?</h5>
                                <p>Several factors contribute to audio latency, including:</p>
                                <ul>
                                    <li><strong>Buffer Size:</strong> Larger audio buffers cause higher latency but provide more stable audio processing.</li>
                                    <li><strong>Sample Rate:</strong> Higher sample rates can reduce latency but require more processing power.</li>
                                    <li><strong>Hardware Limitations:</strong> The quality and speed of your audio interface, computer processor, and USB/audio connections.</li>
                                    <li><strong>Software Processing:</strong> Effects, filters, and digital signal processing add processing time.</li>
                                </ul>
                            </li>
                            <li class="list-group-item">
                                <h5>Acceptable Latency Levels</h5>
                                <p>The acceptable latency depends on your use case:</p>
                                <ul>
                                    <li><strong>Real-time Monitoring:</strong> For musicians or singers monitoring their performance, 10ms or less is ideal.</li>
                                    <li><strong>Video Conferencing:</strong> Under 100ms is acceptable for natural conversation.</li>
                                    <li><strong>Recording Only:</strong> If you're not monitoring in real-time, latency doesn't matter as much.</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-md-12">
                <h2><i class="bi bi-gear-fill me-2"></i>Optimizing Your Microphone Setup</h2>

                <div class="card mb-4">
                    <div class="card-body">
                        <h3>Microphone Placement</h3>
                        <p>Proper microphone placement is often more important than having expensive equipment:</p>

                        <div class="row">
                            <div class="col-md-6">
                                <h5>Distance and Angle</h5>
                                <p>For most voice applications, position the microphone 6-12 inches (15-30 cm) from your mouth. Too close can create plosive sounds (p-pops) and proximity effect (excessive bass). Too far will capture more room reflections and background noise.</p>
                                <p>Speaking at a slight angle to the microphone (rather than directly into it) can reduce plosives while maintaining clarity.</p>
                            </div>
                            <div class="col-md-6">
                                <h5>The Proximity Effect</h5>
                                <p>Directional microphones exhibit a phenomenon called the proximity effect, where bass frequencies are boosted when you speak very close to the microphone. This can be used creatively for a warmer, more intimate sound, but can also make your voice sound muddy if not managed properly.</p>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-12">
                                <h5>Room Acoustics</h5>
                                <p>Your recording environment significantly impacts audio quality. Consider these factors:</p>
                                <ul>
                                    <li><strong>Hard Surfaces:</strong> Walls, floors, and furniture can create echoes and reverberations that make your voice sound hollow or distant.</li>
                                    <li><strong>Background Noise:</strong> Air conditioners, computers, traffic, and other ambient sounds can be picked up by your microphone.</li>
                                    <li><strong>Room Size:</strong> Larger rooms typically have more echo unless treated with acoustic materials.</li>
                                </ul>
                                <p>Simple improvements include:</p>
                                <ul>
                                    <li>Adding soft materials like blankets, curtains, or acoustic panels to reduce reflections</li>
                                    <li>Speaking in smaller rooms with more furniture</li>
                                    <li>Using a microphone with an appropriate pickup pattern for your environment</li>
                                    <li>Creating a simple DIY vocal booth using blankets or acoustic foam</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <h3>Common Microphone Problems and Solutions</h3>

                        <div class="accordion" id="micProblemsAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingDistortion">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDistortion" aria-expanded="false" aria-controls="collapseDistortion">
                                        <i class="bi bi-exclamation-triangle me-2"></i>Distortion and Clipping
                                    </button>
                                </h2>
                                <div id="collapseDistortion" class="accordion-collapse collapse" aria-labelledby="headingDistortion" data-bs-parent="#micProblemsAccordion">
                                    <div class="accordion-body">
                                        <p><strong>Symptoms:</strong> Crackling, popping, or harsh sound quality, especially during louder passages.</p>
                                        <p><strong>Causes:</strong></p>
                                        <ul>
                                            <li>Input level set too high</li>
                                            <li>Speaking too close to the microphone</li>
                                            <li>Faulty cables or connections</li>
                                        </ul>
                                        <p><strong>Solutions:</strong></p>
                                        <ul>
                                            <li>Reduce the input gain/volume in your computer's sound settings</li>
                                            <li>Increase your distance from the microphone</li>
                                            <li>Use a pop filter to reduce plosives</li>
                                            <li>Check and replace cables if necessary</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingLowVolume">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLowVolume" aria-expanded="false" aria-controls="collapseLowVolume">
                                        <i class="bi bi-volume-down me-2"></i>Low Volume
                                    </button>
                                </h2>
                                <div id="collapseLowVolume" class="accordion-collapse collapse" aria-labelledby="headingLowVolume" data-bs-parent="#micProblemsAccordion">
                                    <div class="accordion-body">
                                        <p><strong>Symptoms:</strong> Others can barely hear you, or you need to speak very loudly to be heard.</p>
                                        <p><strong>Causes:</strong></p>
                                        <ul>
                                            <li>Input level set too low</li>
                                            <li>Microphone positioned too far away</li>
                                            <li>Wrong microphone selected in settings</li>
                                            <li>Microphone permissions not granted</li>
                                        </ul>
                                        <p><strong>Solutions:</strong></p>
                                        <ul>
                                            <li>Increase the input gain/volume in your computer's sound settings</li>
                                            <li>Position the microphone closer to your mouth</li>
                                            <li>Verify the correct microphone is selected in your system and application settings</li>
                                            <li>Check that your browser or application has permission to access your microphone</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingBackgroundNoise">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBackgroundNoise" aria-expanded="false" aria-controls="collapseBackgroundNoise">
                                        <i class="bi bi-soundwave me-2"></i>Background Noise
                                    </button>
                                </h2>
                                <div id="collapseBackgroundNoise" class="accordion-collapse collapse" aria-labelledby="headingBackgroundNoise" data-bs-parent="#micProblemsAccordion">
                                    <div class="accordion-body">
                                        <p><strong>Symptoms:</strong> Constant hum, hiss, fans, or environmental sounds in your audio.</p>
                                        <p><strong>Causes:</strong></p>
                                        <ul>
                                            <li>Noisy environment</li>
                                            <li>Computer fans or electrical interference</li>
                                            <li>Low-quality microphone or preamp</li>
                                            <li>Microphone gain set too high</li>
                                        </ul>
                                        <p><strong>Solutions:</strong></p>
                                        <ul>
                                            <li>Move to a quieter location or reduce environmental noise sources</li>
                                            <li>Use a directional microphone (cardioid, supercardioid) to focus on your voice</li>
                                            <li>Enable noise suppression features in your software if available</li>
                                            <li>Position the microphone away from computers, monitors, and electrical devices</li>
                                            <li>Use a noise gate or noise reduction software for post-processing</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingEcho">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEcho" aria-expanded="false" aria-controls="collapseEcho">
                                        <i class="bi bi-arrow-repeat me-2"></i>Echo and Reverb
                                    </button>
                                </h2>
                                <div id="collapseEcho" class="accordion-collapse collapse" aria-labelledby="headingEcho" data-bs-parent="#micProblemsAccordion">
                                    <div class="accordion-body">
                                        <p><strong>Symptoms:</strong> Your voice sounds hollow, distant, or has noticeable reverberations.</p>
                                        <p><strong>Causes:</strong></p>
                                        <ul>
                                            <li>Hard surfaces in your recording environment</li>
                                            <li>Large, empty rooms</li>
                                            <li>Microphone too far from your mouth</li>
                                            <li>Disabled echo cancellation features</li>
                                        </ul>
                                        <p><strong>Solutions:</strong></p>
                                        <ul>
                                            <li>Add soft materials to your environment (blankets, curtains, cushions, etc.)</li>
                                            <li>Move to a smaller room or a room with more furniture</li>
                                            <li>Position the microphone closer to your mouth</li>
                                            <li>Use a directional microphone</li>
                                            <li>Enable echo cancellation in your software if available</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingPlosives">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePlosives" aria-expanded="false" aria-controls="collapsePlosives">
                                        <i class="bi bi-wind me-2"></i>Plosives (P-Pops)
                                    </button>
                                </h2>
                                <div id="collapsePlosives" class="accordion-collapse collapse" aria-labelledby="headingPlosives" data-bs-parent="#micProblemsAccordion">
                                    <div class="accordion-body">
                                        <p><strong>Symptoms:</strong> Explosive sounds on 'p', 'b', and 't' consonants that cause distortion or unpleasant bursts of air.</p>
                                        <p><strong>Causes:</strong></p>
                                        <ul>
                                            <li>Speaking directly into the microphone</li>
                                            <li>Microphone positioned too close to mouth</li>
                                            <li>No pop filter</li>
                                        </ul>
                                        <p><strong>Solutions:</strong></p>
                                        <ul>
                                            <li>Use a pop filter or windscreen</li>
                                            <li>Position the microphone at a 45-degree angle to your mouth</li>
                                            <li>Speak across the microphone rather than directly into it</li>
                                            <li>Maintain a distance of at least 6 inches from the microphone</li>
                                            <li>Practice microphone technique to reduce plosives</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-md-12">
                <h2><i class="bi bi-pc-display me-2"></i>Microphone Tips for Specific Use Cases</h2>

                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h3><i class="bi bi-camera-video me-2"></i>Video Conferencing</h3>
                                <ul>
                                    <li>Test your microphone before important meetings</li>
                                    <li>Use a headset microphone when possible to reduce echo and improve clarity</li>
                                    <li>Enable noise cancellation features in your conferencing software</li>
                                    <li>Mute yourself when not speaking, especially in large meetings</li>
                                    <li>Position yourself in a quiet environment with minimal background noise</li>
                                    <li>Avoid typing or shuffling papers near the microphone</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h3><i class="bi bi-broadcast me-2"></i>Streaming and Content Creation</h3>
                                <ul>
                                    <li>Invest in a quality USB or XLR microphone with good frequency response</li>
                                    <li>Use a pop filter to reduce plosives and breath sounds</li>
                                    <li>Consider a shock mount to minimize handling noise and vibrations</li>
                                    <li>Monitor your audio in real-time with headphones</li>
                                    <li>Learn basic audio processing techniques (compression, EQ, noise gate)</li>
                                    <li>Create a consistent recording environment</li>
                                </ul>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h3><i class="bi bi-music-note-beamed me-2"></i>Music Recording</h3>
                                <ul>
                                    <li>Choose microphones specifically designed for your instruments or vocal style</li>
                                    <li>Experiment with microphone placement to find the optimal sound</li>
                                    <li>Use acoustic treatment to improve room sound</li>
                                    <li>Consider using multiple microphones for complex sound sources</li>
                                    <li>Monitor levels carefully to avoid clipping</li>
                                    <li>Record at 24-bit depth for better dynamic range</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h3><i class="bi bi-phone me-2"></i>Mobile Recording</h3>
                                <ul>
                                    <li>Use an external microphone when possible, even a simple lapel mic can significantly improve quality</li>
                                    <li>Hold the phone steady and avoid touching the microphone area</li>
                                    <li>Record in a quiet environment with minimal wind noise</li>
                                    <li>Keep the microphone at an appropriate distance (not too close, not too far)</li>
                                    <li>Use voice memo or professional recording apps rather than social media apps for better quality</li>
                                    <li>Consider acoustic surroundings - avoid large, empty rooms</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="faq" class="row mt-5">
            <div class="col-md-12">
                <h2><i class="bi bi-question-circle-fill me-2"></i>Frequently Asked Questions</h2>

                <div class="accordion" id="faqAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                <i class="bi bi-question-circle me-2"></i>How to test your mic?
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Testing your microphone with our online tool is pretty simple: just wait until all your multimedia devices are detected and then click the "Test my mic" button. If this button doesn't appear and you haven't received any notifications, it's likely that there's been an error with your browser.
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                <i class="bi bi-question-circle me-2"></i>How is the microphone being tested?
                            </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                <ol>
                                    <li>First of all, it is determined if the browser supports functions for accessing multimedia devices. If so, a list of detected microphones and necessary controls are displayed.</li>
                                    <li>When you click the "Test my mic" button, your browser will ask permission to start the microphone on this site.</li>
                                    <li>Once access is granted, the microphone will start up and you will see the visualizer of sounds captured by your mic.</li>
                                    <li>The tester starts to record your voice and any noise captured by your mic.</li>
                                    <li>Now it's time to determine supported features and make some measurements.</li>
                                    <li>Finally the testing results and hints are displayed.</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingThree">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                <i class="bi bi-question-circle me-2"></i>System Requirements
                            </button>
                        </h2>
                        <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                <p>To test the microphone, you only need a modern browser that supports functions for accessing multimedia devices. Our microphone test tool does not require any additional software such as Adobe Flash, Microsoft Silverlight, or browser plug-ins.</p>
                                <p>There are no restrictions on the type of device, so your microphone can be integrated (into headphones, mobile device, laptop), wireless (WiFi, Bluetooth) or connected via cord (USB, TRL, XLR).</p>
                                <p>Compatible browsers include:</p>
                                <ul>
                                    <li>Chrome 51+</li>
                                    <li>Firefox 38+</li>
                                    <li>Edge 13+</li>
                                    <li>Safari 11.1+</li>
                                    <li>Opera 40+</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingFour">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                                <i class="bi bi-question-circle me-2"></i>Privacy
                            </button>
                        </h2>
                        <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                <ul>
                                    <li>All operations required for testing are performed by the browser and all data is stored in the user's device memory.</li>
                                    <li>We do not store any technical information about your microphone.</li>
                                    <li>All data from the device memory is deleted when the page is closed.</li>
                                    <li>We never store audio recordings made with your microphone.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <footer class="footer">
        <div class="container text-center">
            <p>© 2025 MicTest. Test your microphone online.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Create amplitude bars for the visualizer
            const barsContainer = document.getElementById('amplitude-bars');
            const barsCount = 50;
            for (let i = 0; i < barsCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'amplitude-bar';
                bar.style.height = '0px';
                barsContainer.appendChild(bar);
            }

            const visualizer = document.getElementById('visualizer');
            const micSelect = document.getElementById('mic-select');
            const testButton = document.getElementById('test-button');
            const recordingControls = document.getElementById('recording-controls');
            const playButton = document.getElementById('play-button');
            const pauseButton = document.getElementById('pause-button');
            const stopRecordingButton = document.getElementById('stop-recording-button');
            const restartButton = document.getElementById('restart-button');
            const shareButton = document.getElementById('share-button');
            const recordingProgress = document.getElementById('recording-progress');
            const browserMessage = document.getElementById('browser-message');
            const browserAlert = document.getElementById('browser-alert');
            const statusMessage = document.getElementById('status-message');
            const recordingInstructions = document.getElementById('recording-instructions');
            const amplitudeBars = document.querySelectorAll('.amplitude-bar');
            const audioPlayerContainer = document.getElementById('audio-player-container');
            const audioPlayer = document.getElementById('audio-player');

            // Review form elements
            const addReviewBtn = document.getElementById('add-review-btn');
            const reviewForm = document.getElementById('review-form');
            const submitReviewBtn = document.getElementById('submit-review-btn');
            const cancelReviewBtn = document.getElementById('cancel-review-btn');

            // Info elements
            const micNameEl = document.getElementById('mic-name');
            const gainControlEl = document.getElementById('gain-control');
            const channelsEl = document.getElementById('channels');
            const echoCancellationEl = document.getElementById('echo-cancellation');
            const latencyEl = document.getElementById('latency');
            const noiseSuppressionEl = document.getElementById('noise-suppression');
            const sampleRateEl = document.getElementById('sample-rate');
            const sampleSizeEl = document.getElementById('sample-size');
            const volumeEl = document.getElementById('volume');
            const qualityRatingEl = document.getElementById('quality-rating');

            let audioContext;
            let microphone;
            let analyser;
            let mediaRecorder;
            let audioChunks = [];
            let recordingStartTime;
            let recordingTimer;
            let audioBlob;
            let audioUrl;
            let audioElement;
            let currentState = 'idle'; // idle, detecting, recording, analyzing, complete
            let recordingStopped = false;
            let recordingDuration = 5000; // Default recording duration in ms
            let audioStream; // Store the audio stream for cleanup

            // Check if browser supports audio API
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                updateStatusMessage('danger', 'Your browser does not support microphone access. Please use a modern browser like Chrome, Firefox, or Edge.');
                testButton.disabled = true;
                return;
            }

            function updateStatusMessage(type, message) {
                statusMessage.className = 'status-message alert alert-' + (type || 'info');

                let iconClass = 'bi-info-circle-fill';
                if (type === 'success') iconClass = 'bi-check-circle-fill';
                if (type === 'warning') iconClass = 'bi-exclamation-triangle-fill';
                if (type === 'danger') iconClass = 'bi-x-circle-fill';
                if (type === 'recording') iconClass = 'recording-pulse';

                let displayMessage = message;
                if (type === 'recording') {
                    displayMessage = `<span class="recording-pulse"></span>${message}`;
                } else {
                    displayMessage = `<div class="status-step"><span class="status-icon"><i class="bi ${iconClass}"></i></span><span>${message}</span></div>`;
                }

                statusMessage.innerHTML = displayMessage;

                if (type === 'recording') {
                    recordingInstructions.classList.remove('d-none');
                } else {
                    recordingInstructions.classList.add('d-none');
                }
            }

            // Get available audio devices
            currentState = 'detecting';
            updateStatusMessage('info', 'Detecting your media devices. Please wait...');

            // Add device detection with label fallback for mobile
            navigator.mediaDevices.enumerateDevices()
                .then(devices => {
                    const audioInputDevices = devices.filter(device => device.kind === 'audioinput');

                    if (audioInputDevices.length === 0) {
                        updateStatusMessage('warning', 'No microphone detected. Please connect a microphone and refresh the page.');
                        testButton.disabled = true;
                        currentState = 'idle';
                        return;
                    }

                    // If no labels are available (common on mobile), we need to request permission first
                    const hasLabels = audioInputDevices.some(device => device.label);

                    if (!hasLabels) {
                        // Request temporary permission to get labels
                        navigator.mediaDevices.getUserMedia({ audio: true })
                            .then(tempStream => {
                                // Stop the temporary stream immediately
                                tempStream.getTracks().forEach(track => track.stop());

                                // Now enumerate devices again to get labels
                                navigator.mediaDevices.enumerateDevices()
                                    .then(devicesWithLabels => {
                                        populateMicSelect(devicesWithLabels.filter(device => device.kind === 'audioinput'));
                                    });
                            })
                            .catch(err => {
                                console.error('Error getting temporary permission:', err);
                                // Fallback - still show devices without labels
                                populateMicSelect(audioInputDevices);
                            });
                    } else {
                        // Labels already available, proceed normally
                        populateMicSelect(audioInputDevices);
                    }
                })
                .catch(error => {
                    console.error('Error enumerating devices:', error);
                    updateStatusMessage('danger', 'Error accessing media devices. Please ensure you have given permission to access your microphone.');
                    currentState = 'idle';
                });

            function populateMicSelect(audioInputDevices) {
                // Populate microphone select dropdown
                micSelect.innerHTML = '';
                audioInputDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Microphone ${index + 1}`;
                    micSelect.appendChild(option);
                });

                micSelect.disabled = false;
                currentState = 'idle';

                if (audioInputDevices.length > 1) {
                    updateStatusMessage('success', `${audioInputDevices.length} microphones were detected. To check the functionality and supported properties of your microphone, select it from the list below and press "Test my mic".`);
                } else {
                    updateStatusMessage('success', 'A microphone was detected. Press "Test my mic" to check the functionality and supported properties of your microphone.');
                }
            }

            // Set up canvas for visualization
            const canvasCtx = visualizer.getContext('2d');

            // Test button click handler
            testButton.addEventListener('click', function() {
                if (microphone) {
                    stopMicrophone();
                    resetUI();
                    return;
                }

                const constraints = {
                    audio: {
                        deviceId: micSelect.value ? { exact: micSelect.value } : undefined,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                };

                // Update status
                currentState = 'detecting';
                updateStatusMessage('info', 'Requesting microphone access. Please allow access when prompted.');

                // Request microphone access
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(stream => {
                        // Store the stream for cleanup
                        audioStream = stream;

                        // Create audio context with mobile-friendly initialization
                        initAudioContext();

                        // Update status
                        currentState = 'recording';
                        recordingStopped = false;
                        updateStatusMessage('recording', '<strong>Recording in progress: </strong> Testing your microphone and recording your voice.');

                        // Create analyzer
                        analyser = audioContext.createAnalyser();
                        analyser.fftSize = 2048;

                        // Connect microphone to analyzer
                        microphone = audioContext.createMediaStreamSource(stream);
                        microphone.connect(analyser);

                        // Start visualization
                        visualize();

                        // Update UI
                        testButton.innerHTML = '<i class="bi bi-x-circle-fill me-2"></i>Cancel test';

                        // Show recording controls
                        recordingControls.classList.remove('d-none');

                        // Display microphone info
                        displayMicrophoneInfo(stream);

                        // Set up media recorder
                        setupMediaRecorder(stream);

                        // Start recording
                        startRecording();
                    })
                    .catch(error => {
                        console.error('Error accessing microphone:', error);
                        updateStatusMessage('danger', 'Error accessing your microphone. Please ensure you have given permission to use your microphone.');
                        currentState = 'idle';
                    });
            });

            // Initialize audio context with mobile compatibility
            function initAudioContext() {
                // For mobile compatibility, create the AudioContext only on user interaction
                if (!audioContext) {
                    // Fix for Safari and older browsers
                    window.AudioContext = window.AudioContext || window.webkitAudioContext;
                    audioContext = new AudioContext();

                    // Resume context if it's suspended (needed for iOS Safari)
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                }
            }

            // Visualize microphone input
            function visualize() {
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                canvasCtx.clearRect(0, 0, visualizer.width, visualizer.height);

                function draw() {
                    if (!microphone) return;

                    requestAnimationFrame(draw);

                    analyser.getByteTimeDomainData(dataArray);

                    // Update amplitude bars
                    const barWidth = barsContainer.clientWidth / amplitudeBars.length;
                    const step = Math.floor(bufferLength / amplitudeBars.length);

                    for (let i = 0; i < amplitudeBars.length; i++) {
                        const dataIndex = i * step;
                        const value = Math.abs(dataArray[dataIndex] - 128) / 128;
                        const height = Math.max(3, value * visualizer.height); // Minimum height of 3px
                        amplitudeBars[i].style.height = height + 'px';
                    }

                    canvasCtx.fillStyle = 'rgb(248, 249, 250)';
                    canvasCtx.fillRect(0, 0, visualizer.width, visualizer.height);

                    canvasCtx.lineWidth = 2;
                    canvasCtx.strokeStyle = 'rgb(13, 110, 253)';

                    canvasCtx.beginPath();

                    const sliceWidth = visualizer.width / bufferLength;
                    let x = 0;

                    for (let i = 0; i < bufferLength; i++) {
                        const v = dataArray[i] / 128.0;
                        const y = v * visualizer.height / 2;

                        if (i === 0) {
                            canvasCtx.moveTo(x, y);
                        } else {
                            canvasCtx.lineTo(x, y);
                        }

                        x += sliceWidth;
                    }

                    canvasCtx.lineTo(visualizer.width, visualizer.height / 2);
                    canvasCtx.stroke();

                    // Calculate volume
                    let sum = 0;
                    for (let i = 0; i < bufferLength; i++) {
                        sum += Math.abs(dataArray[i] - 128);
                    }
                    const average = sum / bufferLength;
                    const volume = Math.round((average / 128) * 100);
                    volumeEl.textContent = volume + '%';
                }

                draw();
            }

            // Setup media recorder with mobile compatibility
            function setupMediaRecorder(stream) {
                // Check if MediaRecorder is available
                if (typeof MediaRecorder === 'undefined') {
                    updateStatusMessage('warning', 'Your browser does not support MediaRecorder. Audio recording and playback may not work.');
                    return;
                }

                // Use a more widely supported MIME type for mobile
                let mimeType = 'audio/webm';

                // Check if the browser supports the preferred MIME type
                if (MediaRecorder.isTypeSupported('audio/webm')) {
                    mimeType = 'audio/webm';
                } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4';
                } else if (MediaRecorder.isTypeSupported('audio/ogg')) {
                    mimeType = 'audio/ogg';
                }

                try {
                    mediaRecorder = new MediaRecorder(stream, { mimeType });
                } catch (e) {
                    // Fallback if the specified MIME type isn't supported
                    console.warn('Specified MIME type not supported, using default:', e);
                    mediaRecorder = new MediaRecorder(stream);
                }

                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = function() {
                    finishRecording();
                };

                // Add error handling
                mediaRecorder.onerror = function(event) {
                    console.error('MediaRecorder error:', event);
                    updateStatusMessage('danger', 'An error occurred during recording. Please try again.');
                };
            }

            // Start recording
            function startRecording() {
                audioChunks = [];
                playButton.disabled = true;
                pauseButton.classList.add('d-none');
                audioPlayerContainer.classList.add('d-none');
                recordingStartTime = Date.now();
                recordingStopped = false;

                // Make sure the audioContext is running (important for iOS)
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                try {
                    mediaRecorder.start(100); // Collect data every 100ms for smoother processing
                } catch (e) {
                    console.error('Error starting MediaRecorder:', e);
                    updateStatusMessage('danger', 'Failed to start recording. Please refresh and try again.');
                    return;
                }

                // Update progress bar
                recordingTimer = setInterval(function() {
                    const elapsedTime = Date.now() - recordingStartTime;
                    const progress = Math.min(100, (elapsedTime / recordingDuration) * 100);
                    recordingProgress.style.width = progress + '%';

                    // Update percentage in status message if still in recording phase
                    if (currentState === 'recording' && !recordingStopped) {
                        const progressLabel = Math.floor(progress);
                        updateStatusMessage('recording', `<strong>${progressLabel}.0% Recording in progress: </strong> Testing your microphone and recording your voice.`);
                    }

                    if (progress >= 100) {
                        clearInterval(recordingTimer);
                        stopRecording();
                    }
                }, 50);
            }

            // Stop recording but keep the stream active
            function stopRecording() {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    try {
                        mediaRecorder.stop();
                        recordingStopped = true;
                    } catch (e) {
                        console.error('Error stopping MediaRecorder:', e);
                    }
                }

                if (recordingTimer) {
                    clearInterval(recordingTimer);
                }
            }

            // Process the recording after it's stopped
            function finishRecording() {
                if (audioChunks.length === 0) {
                    updateStatusMessage('warning', 'No audio was recorded. Please try again and make sure your microphone is working.');
                    return;
                }

                try {
                    // Choose MIME type based on browser support
                    let mimeType = 'audio/webm';
                    if (MediaRecorder.isTypeSupported('audio/webm')) {
                        mimeType = 'audio/webm';
                    } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                        mimeType = 'audio/mp4';
                    } else if (MediaRecorder.isTypeSupported('audio/ogg')) {
                        mimeType = 'audio/ogg';
                    }

                    audioBlob = new Blob(audioChunks, { type: mimeType });
                    audioUrl = URL.createObjectURL(audioBlob);

                    // Set source for the HTML5 audio element
                    audioPlayer.src = audioUrl;
                    audioPlayerContainer.classList.remove('d-none');

                    // Also set source for the custom audio element for backward compatibility
                    if (audioElement) {
                        audioElement.remove();
                    }

                    audioElement = document.createElement('audio');
                    audioElement.src = audioUrl;

                    // Setup audio playback controls
                    playButton.disabled = false;
                    restartButton.classList.remove('d-none');
                    shareButton.classList.remove('d-none');

                    // Update state and status
                    currentState = 'complete';
                    updateStatusMessage('success', 'Recording complete! Your microphone is working properly. You can now play back your recording or test again.');

                    // Add event listener to show play/pause toggle
                    audioPlayer.onplay = function() {
                        playButton.classList.add('d-none');
                        pauseButton.classList.remove('d-none');
                    };

                    audioPlayer.onpause = function() {
                        pauseButton.classList.add('d-none');
                        playButton.classList.remove('d-none');
                    };

                    audioPlayer.onended = function() {
                        pauseButton.classList.add('d-none');
                        playButton.classList.remove('d-none');
                    };
                } catch (e) {
                    console.error('Error creating audio blob:', e);
                    updateStatusMessage('danger', 'An error occurred processing the recording. Please try again.');
                }
            }

            // Reset UI to initial state
            function resetUI() {
                testButton.innerHTML = '<i class="bi bi-mic-fill me-2"></i>Test my mic';
                recordingControls.classList.add('d-none');
                audioPlayerContainer.classList.add('d-none');
                resetMicInfo();
                currentState = 'idle';
                updateStatusMessage('info', 'Select your microphone from the dropdown and press "Test my mic" to begin.');
                shareButton.classList.add('d-none');
                restartButton.classList.add('d-none');

                // Release audio resources
                if (audioUrl) {
                    URL.revokeObjectURL(audioUrl);
                    audioUrl = null;
                }
            }

            // Stop microphone
            function stopMicrophone() {
                if (microphone) {
                    microphone.disconnect();
                    microphone = null;
                }

                // Clean up the AudioContext
                if (audioContext) {
                    // Don't close the context as it may be reused
                    if (audioContext.state === 'running') {
                        audioContext.suspend();
                    }
                }

                // Properly stop all tracks in the stream
                if (audioStream) {
                    audioStream.getTracks().forEach(track => track.stop());
                    audioStream = null;
                }

                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    try {
                        mediaRecorder.stop();
                    } catch (e) {
                        console.error('Error stopping MediaRecorder:', e);
                    }
                }

                if (recordingTimer) {
                    clearInterval(recordingTimer);
                }

                canvasCtx.clearRect(0, 0, visualizer.width, visualizer.height);

                // Reset amplitude bars
                for (let i = 0; i < amplitudeBars.length; i++) {
                    amplitudeBars[i].style.height = '0px';
                }
            }

            // Display microphone information
            function displayMicrophoneInfo(stream) {
                const track = stream.getAudioTracks()[0];
                const settings = track.getSettings();

                micNameEl.textContent = track.label || 'Unknown microphone';
                gainControlEl.textContent = settings.autoGainControl ? 'Yes' : 'No';
                channelsEl.textContent = settings.channelCount || '1';
                echoCancellationEl.textContent = settings.echoCancellation ? 'Yes' : 'No';
                latencyEl.textContent = settings.latency ? settings.latency + 'ms' : 'Unknown';
                noiseSuppressionEl.textContent = settings.noiseSuppression ? 'Yes' : 'No';
                sampleRateEl.textContent = settings.sampleRate ? settings.sampleRate + 'Hz' : 'Unknown';
                sampleSizeEl.textContent = settings.sampleSize ? settings.sampleSize + 'bits' : 'Unknown';

                // Calculate quality rating based on settings
                let qualityScore = 0;

                if (settings.channelCount && settings.channelCount >= 2) qualityScore += 1;
                if (settings.sampleRate && settings.sampleRate >= 44100) qualityScore += 1;
                if (settings.sampleSize && settings.sampleSize >= 24) qualityScore += 1;
                if (settings.autoGainControl) qualityScore += 0.5;
                if (settings.echoCancellation) qualityScore += 0.5;
                if (settings.noiseSuppression) qualityScore += 0.5;
                if (settings.latency && settings.latency < 50) qualityScore += 0.5;

                let qualityRating;
                let qualityClass;

                if (qualityScore >= 4) {
                    qualityRating = 'Excellent';
                    qualityClass = 'quality-excellent';
                }
                else if (qualityScore >= 3) {
                    qualityRating = 'Very Good';
                    qualityClass = 'quality-verygood';
                }
                else if (qualityScore >= 2) {
                    qualityRating = 'Good';
                    qualityClass = 'quality-good';
                }
                else if (qualityScore >= 1) {
                    qualityRating = 'Fair';
                    qualityClass = 'quality-fair';
                }
                else {
                    qualityRating = 'Poor';
                    qualityClass = 'quality-poor';
                }

                qualityRatingEl.textContent = qualityRating;
                qualityRatingEl.className = 'quality-indicator ' + qualityClass;
            }

            // Reset microphone information
            function resetMicInfo() {
                micNameEl.textContent = 'Not selected';
                gainControlEl.textContent = '—';
                channelsEl.textContent = '—';
                echoCancellationEl.textContent = '—';
                latencyEl.textContent = '—';
                noiseSuppressionEl.textContent = '—';
                sampleRateEl.textContent = '—';
                sampleSizeEl.textContent = '—';
                volumeEl.textContent = '—';
                qualityRatingEl.textContent = '—';
                qualityRatingEl.className = 'quality-indicator quality-unknown';
            }

            // Play button click handler
            playButton.addEventListener('click', function() {
                if (audioPlayer && audioPlayer.src) {
                    // First try the HTML5 audio player
                    try {
                        audioPlayer.play()
                        .then(() => {
                            playButton.classList.add('d-none');
                            pauseButton.classList.remove('d-none');
                        })
                        .catch(e => {
                            console.error('Error playing audio:', e);
                            // If HTML5 player fails, try the custom audio element
                            if (audioElement) {
                                audioElement.play();
                                playButton.classList.add('d-none');
                                pauseButton.classList.remove('d-none');
                            }
                        });
                    } catch (e) {
                        console.error('Error playing audio:', e);
                        updateStatusMessage('warning', 'Error playing audio. This might be a browser limitation.');
                    }
                }
            });

            // Pause button click handler
            pauseButton.addEventListener('click', function() {
                // Try both the HTML5 player and the custom element
                if (audioPlayer && !audioPlayer.paused) {
                    audioPlayer.pause();
                }

                if (audioElement && !audioElement.paused) {
                    audioElement.pause();
                }

                pauseButton.classList.add('d-none');
                playButton.classList.remove('d-none');
            });

            // Stop recording button click handler
            stopRecordingButton.addEventListener('click', function() {
                if (currentState === 'recording' && !recordingStopped) {
                    stopRecording();
                }
            });

            // Restart button click handler
            restartButton.addEventListener('click', function() {
                if (audioStream && currentState === 'complete') {
                    // Only restart the recording, keep the stream active
                    startRecording();
                    currentState = 'recording';
                    updateStatusMessage('recording', '<strong>Recording in progress: </strong> Testing your microphone and recording your voice.');
                    restartButton.classList.add('d-none');
                    shareButton.classList.add('d-none');
                }
            });

            // Share button click handler
            shareButton.addEventListener('click', function() {
                // Toggle review form
                reviewForm.style.display = 'block';
                this.disabled = true;
            });

            // Review form handlers
            addReviewBtn.addEventListener('click', function() {
                reviewForm.style.display = 'block';
            });

            cancelReviewBtn.addEventListener('click', function() {
                reviewForm.style.display = 'none';
                shareButton.disabled = false;
            });

            submitReviewBtn.addEventListener('click', function() {
                const reviewText = document.getElementById('review-text').value;
                const reviewerName = document.getElementById('reviewer-name').value;

                if (reviewText && reviewerName) {
                    // Create new testimonial
                    const testimonialDiv = document.createElement('div');
                    testimonialDiv.className = 'testimonial';

                    const reviewPara = document.createElement('p');
                    reviewPara.className = 'mb-0';
                    reviewPara.textContent = `"${reviewText}"`;

                    const nameSmall = document.createElement('small');
                    nameSmall.className = 'text-muted';
                    nameSmall.textContent = `— ${reviewerName}`;

                    testimonialDiv.appendChild(reviewPara);
                    testimonialDiv.appendChild(nameSmall);

                    // Insert at the beginning of testimonials
                    const testimonialsContainer = document.querySelector('.card-body');
                    testimonialsContainer.insertBefore(testimonialDiv, testimonialsContainer.firstChild);

                    // Reset form and hide it
                    document.getElementById('review-text').value = '';
                    document.getElementById('reviewer-name').value = '';
                    reviewForm.style.display = 'none';
                    shareButton.disabled = false;

                    // Show success message
                    alert('Thank you for your review!');
                } else {
                    alert('Please fill in both fields');
                }
            });

            // Handle canvas resizing
            function resizeCanvas() {
                visualizer.width = visualizer.clientWidth;
                visualizer.height = visualizer.clientHeight;
            }

            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            // Add event listeners for audio context state changes - important for mobile
            document.addEventListener('touchstart', function() {
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            }, { once: true });

            // Force audio to play on user interaction (for iOS)
            document.addEventListener('touchend', function() {
                if (audioPlayer && audioPlayer.src && audioPlayer.paused) {
                    audioPlayer.play().catch(e => console.log('Play attempted but not allowed yet'));
                }
            }, { once: true });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
